<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body,html{margin:0;padding:0;font-family:Arial, sans-serif;background:#f0f2f5;}
header{position:fixed;top:0;left:0;width:100%;background:#3498db;color:#fff;padding:15px;text-align:center;font-size:1.2em;font-weight:bold;box-shadow:0 3px 6px rgba(0,0,0,0.2);z-index:1000;}
.container{max-width:1200px;margin:auto;padding:90px 15px 15px 15px;}
.cards{display:flex;overflow-x:auto;gap:10px;padding:10px 0;}
.card{flex:0 0 200px;background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.15);transition:transform 0.2s;}
.card:hover{transform:scale(1.05);}
.card h3{margin-bottom:10px;}
.card p{font-size:22px;font-weight:bold;}
.charts{display:flex;flex-direction:column;gap:20px;margin-top:20px;}
.chart-box{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.form-box{background:#fff;padding:15px;border-radius:12px;margin-top:20px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.form-box h3{margin-bottom:10px;}
input,select,button{width:100%;margin:5px 0;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:1em;}
button.btn-add{background:#3498db;color:#fff;border:none;font-weight:bold;font-size:1em;}
.table-box{background:#fff;padding:15px;border-radius:12px;margin-top:20px;overflow-x:auto;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center;font-size:0.9em;}
@media(min-width:768px){.cards{flex-wrap:wrap;}.card{flex:1;}}
</style>
</head>

<body>

<header>
  <span id="eventoTopo">Nenhum evento selecionado</span>
</header>

<div class="container">

  <!-- FORMULÃRIO DE EVENTO -->
  <div class="form-box">
    <h3>ðŸ“… Selecionar Evento</h3>
    <input id="eventoNome" placeholder="Digite o nome do evento">
    <button class="btn-add" onclick="definirEvento()">Selecionar Evento</button>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card" id="cardReceita"><h3>Receitas</h3><p id="receita">R$ 0,00</p></div>
    <div class="card" id="cardDespesa"><h3>Despesas</h3><p id="despesa">R$ 0,00</p></div>
    <div class="card" id="cardResultado"><h3>Resultado</h3><p id="resultado">R$ 0,00</p></div>
  </div>

  <!-- GRÃFICOS -->
  <div class="charts">
    <div class="chart-box"><canvas id="barChart"></canvas></div>
    <div class="chart-box"><canvas id="pieChart"></canvas></div>
  </div>

  <!-- TABELA DETALHADA -->
  <div class="table-box">
    <h3>ðŸ“‹ Detalhamento</h3>
    <table>
      <thead>
        <tr><th>Categoria</th><th>Item</th><th>Valor</th></tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

</div>

<script>
const API_URL = https://script.google.com/macros/s/AKfycbxQJ_0NInJ99dneHs5Lpcma4RgbpCH-mHy-1oPtuo8qVYfmGFd_DadVse7guNibdxTV/exec
  
let dados = [];
let pendentes = [];
let barChart, pieChart;
let eventoAtivo = null;

const receitaEl = document.getElementById('receita');
const despesaEl = document.getElementById('despesa');
const resultadoEl = document.getElementById('resultado');
const tabelaEl = document.getElementById('tabela');
const eventoTopo = document.getElementById('eventoTopo');
const eventoNome = document.getElementById('eventoNome');

function parseNumber(v){
  if(!v) return 0;
  return parseFloat(String(v).replace(/\./g,'').replace(',','.')) || 0;
}

function definirEvento(){
  const nome = eventoNome.value.trim();
  if(!nome){ alert("Digite o nome do evento"); return; }
  eventoAtivo = nome;
  localStorage.setItem('eventoAtivo', eventoAtivo);
  eventoTopo.innerText = eventoAtivo;
  atualizar();
  enviarPendentes();
}

// CARREGAR DADOS ONLINE
async function carregarOnline() {
  try {
    const r = await fetch(API_URL);
    const json = await r.json();

    dados = json.map(d => ({
      Evento: d.Evento,
      Tipo: d.Tipo,
      Categoria: d.Categoria || "Sem Categoria",
      Item: d.Item || "Sem Item",
      ValorTotal: parseNumber(d["Valor Total"])
    }));

    localStorage.setItem('dadosOffline', JSON.stringify(dados));
  } catch(err){
    console.log("Offline, usando dados locais");
    const offline = localStorage.getItem('dadosOffline');
    dados = offline ? JSON.parse(offline) : [];
  }

  atualizar();
}

// ENVIAR LANÃ‡AMENTOS PENDENTES
async function enviarPendentes(){
  if(!navigator.onLine) return;
  const pend = JSON.parse(localStorage.getItem('pendentes') || '[]');
  for(const p of pend){
    try {
      await fetch(API_URL,{method:'POST',body: JSON.stringify(p)});
    } catch(e){
      console.log("Offline, nÃ£o foi possÃ­vel enviar pendentes");
      return;
    }
  }
  localStorage.setItem('pendentes','[]');
  pendentes = [];
  carregarOnline();
}

function atualizar(){
  if(!eventoAtivo){ eventoTopo.innerText='Nenhum evento selecionado'; return; }

  const filtrados = dados.filter(d => d.Evento === eventoAtivo);

  let receita=0, despesa=0, categorias={};

  filtrados.forEach(d=>{
    if(d.Tipo === "Receita") receita += d.ValorTotal;
    if(d.Tipo === "Despesa"){
      despesa += d.ValorTotal;
      categorias[d.Categoria] = (categorias[d.Categoria] || 0) + d.ValorTotal;
    }
  });

  const saldo = receita - despesa;

  receitaEl.innerText = receita.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  despesaEl.innerText = despesa.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.innerText = saldo.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.style.color = saldo >= 0 ? '#2ecc71' : '#e74c3c';

  montarTabela(filtrados);
  desenharGraficos(receita, despesa, categorias);
}

// MONTAR TABELA
function montarTabela(filtrados){
  tabelaEl.innerHTML = '';
  filtrados.forEach(d=>{
    tabelaEl.innerHTML += `
      <tr>
        <td>${d.Categoria}</td>
        <td>${d.Item}</td>
        <td>${d.ValorTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
      </tr>`;
  });
}

// GRÃFICOS
function gerarCores(q){ return Array.from({length:q},(_,i)=>`rgb(${220-i*120/q},60,60)`); }
function desenharGraficos(receita, despesa, categorias){
  if(barChart) barChart.destroy();
  if(pieChart) pieChart.destroy();

  barChart = new Chart(document.getElementById('barChart'),{
    type:'bar',
    data:{
      labels:['Receita','Despesa'],
      datasets:[{data:[receita,despesa],backgroundColor:['#2ecc71','#e74c3c']}]
    }
  });

  pieChart = new Chart(document.getElementById('pieChart'),{
    type:'pie',
    data:{
      labels:Object.keys(categorias),
      datasets:[{data:Object.values(categorias),backgroundColor:gerarCores(Object.keys(categorias).length)}]
    }
  });
}

// EVENTOS ONLINE/OFFLINE
window.addEventListener('online', ()=>{ enviarPendentes(); carregarOnline(); });
window.addEventListener('offline', ()=>{ console.log("VocÃª estÃ¡ offline"); });

// INICIALIZAÃ‡ÃƒO
pendentes = JSON.parse(localStorage.getItem('pendentes') || '[]');
eventoAtivo = localStorage.getItem('eventoAtivo');
if(eventoAtivo) eventoTopo.innerText = eventoAtivo;

carregarOnline();

// SERVICE WORKER
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>



