<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro - App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body,html{margin:0;padding:0;font-family:Arial, sans-serif;background:#f0f2f5;}
header{position:fixed;top:0;left:0;width:100%;background:#3498db;color:#fff;padding:15px;text-align:center;font-size:1.2em;font-weight:bold;box-shadow:0 3px 6px rgba(0,0,0,0.2);z-index:1000;}
.container{max-width:1200px;margin:auto;padding:90px 15px 15px 15px;}
.cards{display:flex;overflow-x:auto;gap:10px;padding:10px 0;}
.card{flex:0 0 200px;background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.15);transition:transform 0.2s;}
.card:hover{transform:scale(1.05);}
.card h3{margin-bottom:10px;}
.card p{font-size:22px;font-weight:bold;}
.charts{display:flex;flex-direction:column;gap:20px;margin-top:20px;}
.chart-box{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.form-box{background:#fff;padding:15px;border-radius:12px;margin-top:20px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.form-box h3{margin-bottom:10px;}
input,select,button{width:100%;margin:5px 0;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:1em;}
button.btn-add{background:#3498db;color:#fff;border:none;font-weight:bold;font-size:1em;}
button.btn-remove{background:#e74c3c;color:#fff;border:none;font-weight:bold;font-size:1em;}
.table-box{background:#fff;padding:15px;border-radius:12px;margin-top:20px;overflow-x:auto;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
table{width:100%;border-collapse:collapse;}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center;font-size:0.9em;}
@media(min-width:768px){.cards{flex-wrap:wrap;}.card{flex:1;}}
</style>
</head>

<body>

<header>
  <span id="eventoTopo">Nenhum evento selecionado</span>
</header>

<div class="container">

  <!-- FORMULÃRIO DE EVENTO -->
  <div class="form-box">
    <h3>ðŸ“… Evento</h3>
    <input id="eventoNome" placeholder="Nome do evento">
    <input id="eventoData" type="date">
    <button class="btn-add" onclick="definirEvento()">Definir evento</button>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card" id="cardReceita"><h3>Receitas</h3><p id="receita">R$ 0,00</p></div>
    <div class="card" id="cardDespesa"><h3>Despesas</h3><p id="despesa">R$ 0,00</p></div>
    <div class="card" id="cardResultado"><h3>Resultado</h3><p id="resultado">R$ 0,00</p></div>
  </div>

  <!-- GRÃFICOS -->
  <div class="charts">
    <div class="chart-box"><canvas id="barChart"></canvas></div>
    <div class="chart-box"><canvas id="pieChart"></canvas></div>
  </div>

  <!-- FORMULÃRIO DE LANÃ‡AMENTO -->
  <div class="form-box">
    <h3>âž• Novo LanÃ§amento</h3>
    <select id="tipo">
      <option value="Receita">Receita</option>
      <option value="Despesa">Despesa</option>
    </select>
    <select id="categoria">
      <option>InscriÃ§Ãµes</option>
      <option>PatrocÃ­nio</option>
      <option>Kit do Atleta</option>
      <option>DispersÃ£o / Percurso</option>
      <option>Estrutura</option>
      <option>MÃ£o de Obra</option>
      <option>Despesa Fixa</option>
      <option>Despesas Diversas</option>
    </select>
    <input id="item" placeholder="Item">
    <input id="valor" type="number" placeholder="Valor">
    <button class="btn-add" onclick="adicionar()">Adicionar</button>
  </div>

  <!-- TABELA -->
  <div class="table-box">
    <h3>ðŸ“‹ Detalhamento</h3>
    <table>
      <thead>
        <tr><th>Categoria</th><th>Item</th><th>Valor</th><th>AÃ§Ã£o</th></tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzgc5hJXXqAvgZfcHMdAiHX-XAmRSz8MGBeJaZdyTlxk_8Jz2dtoqThGjlmmPap6HBM/exec";

let dados = [];
let barChart, pieChart;
let eventoAtivo = null;

const receitaEl = document.getElementById('receita');
const despesaEl = document.getElementById('despesa');
const resultadoEl = document.getElementById('resultado');
const tabelaEl = document.getElementById('tabela');
const barChartEl = document.getElementById('barChart');
const pieChartEl = document.getElementById('pieChart');
const tipo = document.getElementById('tipo');
const categoria = document.getElementById('categoria');
const item = document.getElementById('item');
const valor = document.getElementById('valor');
const eventoTopo = document.getElementById('eventoTopo');

function parseNumber(v){ return parseFloat(String(v).replace(/\./g,'').replace(',','.')) || 0; }

function definirEvento(){
  const nome = document.getElementById('eventoNome').value;
  const data = document.getElementById('eventoData').value;
  if(!nome || !data){ alert('Informe nome e data do evento'); return; }
  eventoAtivo = `${nome} (${data})`;
  localStorage.setItem('eventoAtivo', eventoAtivo);
  eventoTopo.innerText = eventoAtivo;
  atualizar();
}

async function carregarOnline() {
  try {
    const r = await fetch(API_URL);
    if(!r.ok) throw new Error("Erro ao buscar dados");
    dados = await r.json();
    dados.forEach(d => d.valor = parseNumber(d.Valor || d.valor));
    localStorage.setItem('dadosOffline', JSON.stringify(dados));
  } catch (err) {
    console.log("Offline: usando dados salvos localmente");
    const offlineData = localStorage.getItem('dadosOffline');
    if(offlineData) {
      dados = JSON.parse(offlineData);
      dados.forEach(d => d.valor = parseNumber(d.Valor || d.valor));
    } else dados = [];
  }
  atualizar();
}

async function salvarOnline(registro){
  try {
    await fetch(API_URL,{ method:'POST', body: JSON.stringify(registro) });
  } catch(e){
    console.log("NÃ£o foi possÃ­vel salvar online");
  }
}

function atualizar(){
  if(!eventoAtivo){ eventoTopo.innerText='Nenhum evento selecionado'; return; }
  let receita=0, despesa=0, categorias={};
  const filtrados = dados.filter(d => d.Evento === eventoAtivo);
  filtrados.forEach(d=>{
    if(d.Tipo==='Receita') receita+=d.valor;
    if(d.Tipo==='Despesa'){ despesa+=d.valor; categorias[d.Categoria]=(categorias[d.Categoria]||0)+d.valor; }
  });
  const saldo = receita-despesa;
  receitaEl.innerText = receita.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  despesaEl.innerText = despesa.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.innerText = saldo.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.style.color = saldo>=0 ? '#2ecc71' : '#e74c3c';
  document.getElementById('cardResultado').style.background = saldo>=0 ? '#e0f7e9' : '#fde0e0';
  montarTabela(filtrados);
  desenharGraficos(receita,despesa,categorias);
}

function montarTabela(filtrados){
  tabelaEl.innerHTML='';
  filtrados.forEach(d=>{
    tabelaEl.innerHTML+=`
    <tr>
      <td>${d.Categoria}</td>
      <td>${d.Item}</td>
      <td>${d.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
      <td>Online</td>
    </tr>`;
  });
}

function adicionar(){
  if(!item.value || !valor.value) return;
  const novo = { Tipo: tipo.value, Categoria: categoria.value, Item: item.value, Valor: valor.value, Evento: eventoAtivo };
  dados.push({...novo, valor: parseNumber(valor.value)});
  salvarOnline(novo);
  atualizar();
  item.value=''; valor.value='';
}

function gerarVermelhos(q){ return Array.from({length:q},(_,i)=>`rgb(${220-i*120/q},60,60)`); }

function desenharGraficos(receita,despesa,categorias){
  if(barChart) barChart.destroy();
  if(pieChart) pieChart.destroy();
  barChart = new Chart(barChartEl,{ type:'bar', data:{ labels:['Receita','Despesa'], datasets:[{data:[receita,despesa]}] } });
  pieChart = new Chart(pieChartEl,{ type:'pie', data:{ labels:Object.keys(categorias), datasets:[{data:Object.values(categorias),backgroundColor:gerarVermelhos(Object.keys(categorias).length)}] } });
}

carregarOnline();
if ('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>

</body>
</html>
