<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxQJ_0NInJ99dneHs5Lpcma4RgbpCH-mHy-1oPtuo8qVYfmGFd_DadVse7guNibdxTV/exec";

let dadosGlobal = [];
let barChart, pieChart;

// Converte número BR ou US
function parseNumber(v) {
    if (v === undefined || v === null || v === "") return 0;
    if (typeof v === "number") return v;

    return Number(
        String(v)
            .replace("R$", "")
            .replace(/\s/g, "")
            .replace(/\./g, "")
            .replace(",", ".")
    ) || 0;
}

// ==========================
// 1️⃣ CARREGA DADOS
// ==========================
async function carregarDados() {
    const status = document.getElementById("status");

    try {
        const resp = await fetch(API_URL + "?t=" + Date.now());
        const json = await resp.json();

        console.log("Dados recebidos:", json);

        dadosGlobal = json.map(l => ({
            Tipo: String(l.Tipo || "").trim().toLowerCase(),
            Categoria: l.Categoria || "Geral",
            Item: l.Item || "S/N",
            ValorTotal: parseNumber(l.ValorTotal)
        }));

        status.innerText = `Sincronizado: ${dadosGlobal.length} linhas`;
        status.style.color = "#2ecc71";

        atualizarInterface();

    } catch (e) {
        console.error(e);
        status.innerText = "Erro ao carregar dados";
        status.style.color = "#e74c3c";
    }
}

// ==========================
// 2️⃣ ATUALIZA TELA
// ==========================
function atualizarInterface() {
    let receitas = 0;
    let despesas = 0;
    let categorias = {};

    const linhas = dadosGlobal.map(d => {
        if (d.Tipo === "receita") {
            receitas += d.ValorTotal;
        } else {
            despesas += d.ValorTotal;
            categorias[d.Categoria] = (categorias[d.Categoria] || 0) + d.ValorTotal;
        }

        return `
            <tr>
                <td>${d.Categoria}</td>
                <td>${d.Item}</td>
                <td style="font-weight:bold">
                    ${d.ValorTotal.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
                </td>
            </tr>
        `;
    }).join("");

    document.getElementById("tabelaCorpo").innerHTML = linhas;
    document.getElementById("receita").innerText =
        receitas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    document.getElementById("despesa").innerText =
        despesas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

    const saldo = receitas - despesas;
    const saldoEl = document.getElementById("saldo");
    saldoEl.innerText = saldo.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    saldoEl.style.color = saldo >= 0 ? "var(--success)" : "var(--danger)";

    renderizarGraficos(receitas, despesas, categorias);
}

// ==========================
// 3️⃣ GRÁFICOS
// ==========================
function renderizarGraficos(rec, des, cats) {
    if (barChart) barChart.destroy();
    if (pieChart) pieChart.destroy();

    barChart = new Chart(barChart = document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: ["Receitas", "Despesas"],
            datasets: [{
                data: [rec, des],
                backgroundColor: ["#2ecc71", "#e74c3c"]
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });

    pieChart = new Chart(document.getElementById("pieChart"), {
        type: "doughnut",
        data: {
            labels: Object.keys(cats),
            datasets: [{
                data: Object.values(cats)
            }]
        }
    });
}

window.onload = carregarDados;
</script>

