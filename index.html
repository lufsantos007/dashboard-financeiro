<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.container{max-width:1200px;margin:auto;padding:15px}
h1{text-align:center}

input,select,button{
  width:100%;
  margin:5px 0;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
}

.btn-add{background:#3498db;color:#fff;border:none;font-weight:bold}
.btn-remove{background:#e74c3c;color:#fff;border:none}

.cards{display:flex;flex-direction:column;gap:10px}
.card{background:#fff;padding:15px;border-radius:10px;text-align:center}
.card p{font-size:22px;font-weight:bold;margin:5px 0}

.charts{display:flex;flex-direction:column;gap:20px;margin-top:20px}
.chart-box,.table-box,.form-box{
  background:#fff;padding:15px;border-radius:10px;margin-top:20px
}

table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}

@media(min-width:768px){
  .cards{flex-direction:row}
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸ“Š Dashboard Financeiro</h1>

<div class="form-box">
  <h3>ðŸ“… Evento</h3>
  <input id="eventoNome" placeholder="Nome do evento">
  <input id="eventoData" type="date">
  <button class="btn-add" onclick="definirEvento()">Definir evento</button>
  <p id="eventoAtual" style="margin-top:10px;font-weight:bold"></p>
</div>

<div class="cards">
  <div class="card"><h3>Receitas</h3><p id="receita">R$ 0,00</p></div>
  <div class="card"><h3>Despesas</h3><p id="despesa">R$ 0,00</p></div>
  <div class="card"><h3>Resultado</h3><p id="resultado">R$ 0,00</p></div>
</div>

<div class="charts">
  <div class="chart-box"><canvas id="barChart"></canvas></div>
  <div class="chart-box"><canvas id="pieChart"></canvas></div>
</div>

<div class="form-box">
<h3>âž• Novo LanÃ§amento</h3>
<select id="tipo">
  <option value="Receita">Receita</option>
  <option value="Despesa">Despesa</option>
</select>
<select id="categoria">
  <option>InscriÃ§Ãµes</option>
  <option>PatrocÃ­nio</option>
  <option>Kit do Atleta</option>
  <option>DispersÃ£o / Percurso</option>
  <option>Estrutura</option>
  <option>MÃ£o de Obra</option>
  <option>Despesa Fixa</option>
  <option>Despesas Diversas</option>
</select>
<input id="item" placeholder="Item">
<input id="valor" type="number" placeholder="Valor">
<button class="btn-add" onclick="adicionar()">Adicionar</button>
</div>

<div class="table-box">
<h3>ðŸ“‹ Detalhamento</h3>
<table>
<thead>
<tr>
<th>Categoria</th>
<th>Item</th>
<th>Valor</th>
<th>AÃ§Ã£o</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>
</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzgc5hJXXqAvgZfcHMdAiHX-XAmRSz8MGBeJaZdyTlxk_8Jz2dtoqThGjlmmPap6HBM/exec";

let dados = [];
let barChart, pieChart;
let eventoAtivo = null;

const receitaEl = document.getElementById('receita');
const despesaEl = document.getElementById('despesa');
const resultadoEl = document.getElementById('resultado');
const tabelaEl = document.getElementById('tabela');
const barChartEl = document.getElementById('barChart');
const pieChartEl = document.getElementById('pieChart');
const tipo = document.getElementById('tipo');
const categoria = document.getElementById('categoria');
const item = document.getElementById('item');
const valor = document.getElementById('valor');

function parseNumber(v){ return parseFloat(String(v).replace(/\./g,'').replace(',','.')) || 0; }

function definirEvento(){
  const nome = document.getElementById('eventoNome').value;
  const data = document.getElementById('eventoData').value;
  if(!nome || !data){ alert('Informe nome e data do evento'); return; }
  eventoAtivo = `${nome} (${data})`;
  localStorage.setItem('eventoAtivo', eventoAtivo);
  document.getElementById('eventoAtual').innerText = 'Evento ativo: ' + eventoAtivo;
  atualizar();
}

async function carregarOnline(){
  const r = await fetch(API_URL);
  dados = await r.json();
  dados.forEach(d => d.valor = parseNumber(d.Valor || d.valor));
  atualizar();
}

async function salvarOnline(registro){
  await fetch(API_URL,{ method:'POST', body: JSON.stringify(registro) });
}

function atualizar(){
  if(!eventoAtivo){
    document.getElementById('eventoAtual').innerText = 'Nenhum evento selecionado';
    return;
  }
  let receita=0, despesa=0, categorias={};
  const filtrados = dados.filter(d => d.Evento === eventoAtivo);
  filtrados.forEach(d=>{
    if(d.Tipo==='Receita') receita+=d.valor;
    if(d.Tipo==='Despesa'){ despesa+=d.valor; categorias[d.Categoria]=(categorias[d.Categoria]||0)+d.valor; }
  });
  const saldo = receita-despesa;
  receitaEl.innerText = receita.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  despesaEl.innerText = despesa.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.innerText = saldo.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  resultadoEl.style.color = saldo>=0 ? '#2ecc71' : '#e74c3c';
  montarTabela(filtrados);
  desenharGraficos(receita,despesa,categorias);
}

function montarTabela(filtrados){
  tabelaEl.innerHTML='';
  filtrados.forEach(d=>{
    tabelaEl.innerHTML+=`
    <tr>
      <td>${d.Categoria}</td>
      <td>${d.Item}</td>
      <td>${d.valor.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
      <td>Online</td>
    </tr>`;
  });
}

function adicionar(){
  if(!item.value || !valor.value) return;
  const novo = { Tipo: tipo.value, Categoria: categoria.value, Item: item.value, Valor: valor.value, Evento: eventoAtivo };
  dados.push({...novo, valor: parseNumber(valor.value)});
  salvarOnline(novo);
  atualizar();
  item.value=''; valor.value='';
}

function gerarVermelhos(q){ return Array.from({length:q},(_,i)=>`rgb(${220-i*120/q},60,60)`); }

function desenharGraficos(receita,despesa,categorias){
  if(barChart) barChart.destroy();
  if(pieChart) pieChart.destroy();
  barChart = new Chart(barChartEl,{ type:'bar', data:{ labels:['Receita','Despesa'], datasets:[{data:[receita,despesa]}] } });
  pieChart = new Chart(pieChartEl,{ type:'pie', data:{ labels:Object.keys(categorias), datasets:[{data:Object.values(categorias),backgroundColor:gerarVermelhos(Object.keys(categorias).length)}] } });
}

/* INICIAR */
carregarOnline();

/* SERVICE WORKER */
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
